---
layout: post
title: 接口加密鉴权
date: 2019-03-01 10:36
tags:
  - 技术
  - 安全
---

## 使用场景

先抽象的描述一下使用场景吧。客户端请求服务端获取系统资源的时候，会存在接口劫持篡改发回服务的数据。于是客户端就可以获取付费的本地使用特效，
包括付费皮肤,书籍,本地游戏特效等等。

## 具体实践

### 背景知识

- [base64 编码 【中文】](https://baike.baidu.com/item/base64/8545775?fr=aladdin "base64 编码")
- [base64 编码 【english】](https://en.wikipedia.org/wiki/Base64 "base64 编码")
- [md5 加密 【english】](https://en.wikipedia.org/wiki/MD5 "md5 加密")
- [md5 加密【中文】](https://baike.baidu.com/item/MD5/212708?fr=aladdin "md5 加密")
  <!--more -->

### 具体使用场景

app 客户端推出了一个一键换肤的功能,考虑到这个换肤的功能后期会存在付费的功能,还可能会计算挂钩的收益结算，需要的皮肤这种资源进行保护。
如果不进行保护的话会存在如下风险。

- 用户通过篡改接口来更换皮肤包资源可以自己随意定制皮肤包。如果教程公布到网上，这样第三方的山寨皮肤包就会盛行。绕过审核，产生抹黑公司形象和难以想象的法律风险。
- 用户只要懂得抓包和接口劫持篡改的知识，就可以将网上流传的付费皮肤包资源篡改到付费皮肤包的网络请求中去。达到免费使用付费皮肤的目的。

### 具体操作方法

**问题：** 客户端需要相信接口下发的数据是真实的，接口端的数据不能被篡改，一旦被篡改客户端可以感知的到。

**思路：** 客户端传一个随机字符串给服务端，服务端接受到请求后再参数一个随机字符串，根据这两个字符串加上需要返回的数据再加上约定要的秘钥 key 生成一个签名
然后将这个签名和服务端的随机数和需要传递的数据传递客户端，客户端根据这些数据来校验这个签名是否合法。

**代码 demo**:[点我](https://github.com/linthan/encryptapi-demo "demo")

#### 备注

返回的数据一般是 json 格式的数据，计算签名的时候需要使用 json 格式数据的字符串，经过 base64 编码以后的字符串来计算 sign。传递数据给客户端的数据是这个 base64 编码字符串。
**理由如下：**
实际操作中会存在服务端 json 字符串和客户端 json 字符串经过网络传输以后数据不一致的情况,计算的 sign 会不一致。直接使用 json 字符串，还有不必要的字符串转义的烦恼。

#### 流程图

![](/blog/assets/blogImg/security/dairy-20190301.png)

#### 接口格式

**请求参数**：

| 参数名 | 字段解释   | 字段类型 | 默认值 | 说明    |
| ------ | ---------- | -------- | ------ | ------- |
| id     | id         | int      | 0      | 大于 0  |
| ver    | 版本       | int      | 0      | 大于 0  |
| r      | 随机字符串 | string   | ""     | 长度 16 |

**返回格式**

```
{
    "error": 0, // 一直为0
    "msg": "ok",
    "data": {
    	"e": 0, // 真实error值
        "r": "uk!cntZs)qk+t&gF",	// 随机字符串
        "s": "3eee660f7728b411a96b9a14cd8d2be6", // 签名
        "data": "base64 字符串"
    }
}
```
